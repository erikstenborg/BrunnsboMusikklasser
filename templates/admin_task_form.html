{% extends "base.html" %}

{% block title %}{{ title }} - Brunnsbo Musikklasser{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-5">
                    <i class="fas fa-tasks me-3"></i>{{ title }}
                </h1>
                <a href="{{ url_for('admin_events') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Tillbaka till evenemang
                </a>
            </div>
            
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>{{ event.title }}
                    </h5>
                    <small>{{ event.event_date.strftime('%d %B %Y kl. %H:%M') }}</small>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else "")) }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback">
                                    {{ form.title.errors[0] }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows="4") }}
                            {% if form.description.errors %}
                                <div class="invalid-feedback">
                                    {{ form.description.errors[0] }}
                                </div>
                            {% endif %}
                            <div class="form-text">Beskriv vad som behöver göras för denna uppgift.</div>
                        </div>
                        
                        <div class="mb-4">
                            {{ form.assigned_to_user_id.label(class="form-label") }}
                            <select name="assigned_to_user_id" id="assigned_to_user_id" 
                                    class="form-select searchable-select{{ ' is-invalid' if form.assigned_to_user_id.errors else '' }}"
                                    data-placeholder="Sök efter användare...">
                                {% for value, label in form.assigned_to_user_id.choices %}
                                    <option value="{{ value }}" 
                                            {% if value == form.assigned_to_user_id.data %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                            {% if form.assigned_to_user_id.errors %}
                                <div class="invalid-feedback">
                                    {{ form.assigned_to_user_id.errors[0] }}
                                </div>
                            {% endif %}
                            <div class="form-text">Välj en användare som ska utföra uppgiften, eller lämna blank för allmän uppgift. Du kan skriva för att söka.</div>
                        </div>
                        
                        <!-- Due date offset section -->
                        <div class="card border-info mb-4">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0">
                                    <i class="fas fa-clock me-2"></i>Förfallodatum (valfritt)
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small">
                                    Ange när uppgiften ska vara klar relativt till evenemangets datum.
                                </p>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        {{ form.due_offset_days.label(class="form-label") }}
                                        {{ form.due_offset_days(class="form-control" + (" is-invalid" if form.due_offset_days.errors else "")) }}
                                        {% if form.due_offset_days.errors %}
                                            <div class="invalid-feedback">
                                                {{ form.due_offset_days.errors[0] }}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">
                                            {{ form.due_offset_days.description }}
                                            <br><strong>Exempel:</strong> -3 = 3 dagar före evenemanget, 1 = 1 dag efter
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.due_offset_hours.label(class="form-label") }}
                                        {{ form.due_offset_hours(class="form-control" + (" is-invalid" if form.due_offset_hours.errors else "")) }}
                                        {% if form.due_offset_hours.errors %}
                                            <div class="invalid-feedback">
                                                {{ form.due_offset_hours.errors[0] }}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">Finjustering av tid</div>
                                    </div>
                                </div>
                                
                                {% if event %}
                                    <div class="mt-3 p-2 bg-light rounded">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            <strong>Evenemang:</strong> {{ event.event_date.strftime('%d %B %Y kl. %H:%M') }}
                                            <span id="calculated-due-date"></span>
                                        </small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            {% if task %}
                                <a href="{{ url_for('admin_event_tasks', event_id=event.id) }}" class="btn btn-secondary">
                                    <i class="fas fa-times me-2"></i>Avbryt
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-2"></i>Spara ändringar
                                </button>
                            {% else %}
                                <a href="{{ url_for('admin_events') }}" class="btn btn-secondary">
                                    <i class="fas fa-times me-2"></i>Avbryt
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus me-2"></i>Skapa uppgift
                                </button>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Calculate and display due date preview
function updateDueDatePreview() {
    const daysInput = document.getElementById('due_offset_days');
    const hoursInput = document.getElementById('due_offset_hours');
    const previewElement = document.getElementById('calculated-due-date');
    
    if (daysInput && hoursInput && previewElement) {
        const days = parseInt(daysInput.value) || 0;
        const hours = parseInt(hoursInput.value) || 0;
        
        if (days !== 0 || hours !== 0) {
            // Calculate due date (this is just for preview, actual calculation is done server-side)
            const eventDate = new Date('{{ event.event_date.strftime("%Y-%m-%dT%H:%M") }}');
            const dueDate = new Date(eventDate.getTime() + (days * 24 * 60 * 60 * 1000) + (hours * 60 * 60 * 1000));
            
            previewElement.innerHTML = '<br><strong>Förfaller:</strong> ' + 
                dueDate.toLocaleDateString('sv-SE', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
        } else {
            previewElement.innerHTML = '';
        }
    }
}

// Add event listeners when page loads
document.addEventListener('DOMContentLoaded', function() {
    const daysInput = document.getElementById('due_offset_days');
    const hoursInput = document.getElementById('due_offset_hours');
    
    if (daysInput) daysInput.addEventListener('input', updateDueDatePreview);
    if (hoursInput) hoursInput.addEventListener('input', updateDueDatePreview);
    
    // Initial calculation
    updateDueDatePreview();
    
    // Initialize searchable select dropdown
    initializeSearchableSelect();
});

// Initialize searchable dropdown functionality
function initializeSearchableSelect() {
    const selectElement = document.querySelector('.searchable-select');
    if (!selectElement) return;
    
    // Create wrapper div
    const wrapper = document.createElement('div');
    wrapper.className = 'searchable-select-wrapper position-relative';
    selectElement.parentNode.insertBefore(wrapper, selectElement);
    wrapper.appendChild(selectElement);
    
    // Create search input
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control searchable-input';
    searchInput.placeholder = selectElement.dataset.placeholder || 'Sök...';
    searchInput.style.display = 'none';
    wrapper.appendChild(searchInput);
    
    // Create dropdown list
    const dropdown = document.createElement('div');
    dropdown.className = 'searchable-dropdown position-absolute w-100 bg-white border rounded shadow-sm';
    dropdown.style.zIndex = '1050';
    dropdown.style.maxHeight = '200px';
    dropdown.style.overflowY = 'auto';
    dropdown.style.display = 'none';
    wrapper.appendChild(dropdown);
    
    // Store original options
    const originalOptions = Array.from(selectElement.options).map(option => ({
        value: option.value,
        text: option.text,
        selected: option.selected
    }));
    
    // Show selected value or placeholder in input
    function updateInputDisplay() {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        if (selectedOption && selectedOption.value) {
            searchInput.value = selectedOption.text;
        } else {
            searchInput.value = '';
        }
    }
    
    // Filter and display options
    function filterOptions(query) {
        dropdown.innerHTML = '';
        const filteredOptions = originalOptions.filter(option => 
            option.text.toLowerCase().includes(query.toLowerCase())
        );
        
        filteredOptions.forEach(option => {
            const item = document.createElement('div');
            item.className = 'p-2 searchable-item';
            item.textContent = option.text;
            item.style.cursor = 'pointer';
            
            if (option.selected) {
                item.classList.add('bg-primary', 'text-white');
            }
            
            item.addEventListener('mouseenter', () => {
                if (!item.classList.contains('bg-primary')) {
                    item.classList.add('bg-light');
                }
            });
            
            item.addEventListener('mouseleave', () => {
                if (!item.classList.contains('bg-primary')) {
                    item.classList.remove('bg-light');
                }
            });
            
            item.addEventListener('click', () => {
                selectElement.value = option.value;
                updateInputDisplay();
                dropdown.style.display = 'none';
                selectElement.style.display = 'block';
                searchInput.style.display = 'none';
            });
            
            dropdown.appendChild(item);
        });
    }
    
    // Initialize display
    selectElement.style.display = 'block';
    updateInputDisplay();
    
    // Handle select click - switch to search mode
    selectElement.addEventListener('click', (e) => {
        e.preventDefault();
        selectElement.style.display = 'none';
        searchInput.style.display = 'block';
        searchInput.focus();
        filterOptions('');
        dropdown.style.display = 'block';
    });
    
    // Handle search input
    searchInput.addEventListener('input', (e) => {
        filterOptions(e.target.value);
        dropdown.style.display = 'block';
    });
    
    // Handle focus loss
    searchInput.addEventListener('blur', (e) => {
        // Delay to allow click on dropdown items
        setTimeout(() => {
            if (!wrapper.contains(document.activeElement)) {
                dropdown.style.display = 'none';
                selectElement.style.display = 'block';
                searchInput.style.display = 'none';
                updateInputDisplay();
            }
        }, 200);
    });
    
    // Handle escape key
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            dropdown.style.display = 'none';
            selectElement.style.display = 'block';
            searchInput.style.display = 'none';
            updateInputDisplay();
        }
    });
}
</script>

<style>
.searchable-select-wrapper {
    position: relative;
}

.searchable-dropdown {
    z-index: 1050;
}

.searchable-item:hover {
    background-color: #f8f9fa !important;
}
</style>
{% endblock %}